<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Lesson Unlock System - Finx</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .test-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .btn-test {
            margin: 0.25rem;
        }
        .progress-display {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-unlocked { background: #d1fae5; color: #065f46; }
        .status-locked { background: #fee2e2; color: #991b1b; }
        .status-completed { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-container">
            <h1 class="text-center mb-4">üß™ Sistema de Desbloqueo de Lecciones - Test</h1>
            <p class="text-center text-muted mb-4">
                Prueba el sistema de desbloqueo autom√°tico de lecciones al completar quizzes
            </p>

            <!-- Current Status Section -->
            <div class="test-section">
                <h3>üìä Estado Actual del Progreso</h3>
                <div id="currentStatus" class="progress-display">
                    <div class="row">
                        <div class="col-md-4">
                            <h5>üí∞ Ahorro Inteligente</h5>
                            <span id="status-ahorro" class="status-indicator">Cargando...</span>
                        </div>
                        <div class="col-md-4">
                            <h5>ü•∑ Savings Ninja</h5>
                            <span id="status-savings" class="status-indicator">Cargando...</span>
                        </div>
                        <div class="col-md-4">
                            <h5>üßô‚Äç‚ôÇÔ∏è Investment Wizard</h5>
                            <span id="status-investment" class="status-indicator">Cargando...</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>XP Total: <span id="totalXP">0</span></h6>
                        <h6>Nivel: <span id="userLevel">1</span></h6>
                    </div>
                </div>
            </div>

            <!-- Test Actions Section -->
            <div class="test-section">
                <h3>üéØ Acciones de Prueba</h3>
                <p>Simula completar quizzes con diferentes puntajes:</p>
                
                <div class="mb-3">
                    <h5>üí∞ Ahorro Inteligente</h5>
                    <button class="btn btn-success btn-test" onclick="simulateQuizCompletion('ahorro_inteligente', 80)">
                        Completar con 80% (Aprobar)
                    </button>
                    <button class="btn btn-warning btn-test" onclick="simulateQuizCompletion('ahorro_inteligente', 45)">
                        Completar con 45% (Reprobar)
                    </button>
                    <button class="btn btn-info btn-test" onclick="simulateQuizCompletion('ahorro_inteligente', 100)">
                        Completar con 100% (Perfecto)
                    </button>
                </div>

                <div class="mb-3">
                    <h5>ü•∑ Savings Ninja</h5>
                    <button class="btn btn-success btn-test" onclick="simulateQuizCompletion('savings_ninja', 75)">
                        Completar con 75% (Aprobar)
                    </button>
                    <button class="btn btn-warning btn-test" onclick="simulateQuizCompletion('savings_ninja', 30)">
                        Completar con 30% (Reprobar)
                    </button>
                </div>

                <div class="mb-3">
                    <h5>üßô‚Äç‚ôÇÔ∏è Investment Wizard</h5>
                    <button class="btn btn-success btn-test" onclick="simulateQuizCompletion('investment_wizard', 90)">
                        Completar con 90% (Aprobar)
                    </button>
                    <button class="btn btn-warning btn-test" onclick="simulateQuizCompletion('investment_wizard', 55)">
                        Completar con 55% (Reprobar)
                    </button>
                </div>
            </div>

            <!-- Reset Section -->
            <div class="test-section">
                <h3>üîÑ Control de Datos</h3>
                <button class="btn btn-danger" onclick="resetAllProgress()">
                    Resetear Todo el Progreso
                </button>
                <button class="btn btn-primary" onclick="updateDisplay()">
                    Actualizar Display
                </button>
                <button class="btn btn-secondary" onclick="viewRawData()">
                    Ver Datos Raw
                </button>
            </div>

            <!-- Navigation -->
            <div class="text-center mt-4">
                <a href="trivia.html" class="btn btn-primary btn-lg">
                    üéÆ Ir a P√°gina Principal de Lecciones
                </a>
            </div>
        </div>
    </div>

    <!-- Lesson Progress Utility -->
    <script src="lesson-progress.js"></script>
    
    <script>
        // Simulate quiz completion with score
        function simulateQuizCompletion(lessonId, score) {
            console.log(`Simulando completar ${lessonId} con puntaje: ${score}%`);
            
            // Save quiz progress using the lesson-progress utility
            const passed = score >= 60;
            
            // Get current progress
            let progress = getUserProgress();
            
            // Update lesson progress
            if (!progress.lessons[lessonId]) {
                progress.lessons[lessonId] = {
                    unlocked: true,
                    completed: false,
                    passed: false,
                    score: 0,
                    attempts: 0,
                    xpEarned: 0
                };
            }
            
            // Update the attempt
            progress.lessons[lessonId].attempts++;
            progress.lessons[lessonId].score = Math.max(progress.lessons[lessonId].score, score);
            
            if (passed) {
                progress.lessons[lessonId].passed = true;
                progress.lessons[lessonId].completed = true;
                
                // Calculate XP (only if not already earned)
                if (!progress.lessons[lessonId].xpEarned) {
                    let xp = 50; // Base XP
                    if (score >= 80) xp += 20; // Bonus for high score
                    if (score === 100) xp += 30; // Perfect score bonus
                    
                    progress.lessons[lessonId].xpEarned = xp;
                    progress.totalXP += xp;
                }
                
                // Show unlock notification
                showUnlockNotification(lessonId, score);
                
                // Unlock next lesson
                const unlocked = unlockNextLesson(lessonId);
                if (unlocked) {
                    console.log(`¬°Siguiente lecci√≥n desbloqueada: ${unlocked}!`);
                }
            } else {
                progress.lessons[lessonId].passed = false;
                progress.lessons[lessonId].completed = false;
                console.log(`Puntaje insuficiente (${score}%). Necesitas al menos 60% para aprobar.`);
            }
            
            // Save progress
            localStorage.setItem('finx_user_progress', JSON.stringify(progress));
            
            // Update display
            setTimeout(() => {
                updateDisplay();
            }, 1000);
        }
        
        // Show notification for unlock
        function showUnlockNotification(lessonId, score) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(16,185,129,0.3);
                z-index: 1000;
                animation: slideInRight 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <h6 style="margin: 0 0 0.5rem 0;">üéâ ¬°Quiz Completado!</h6>
                <p style="margin: 0; opacity: 0.9;">
                    ${lessonId.replace('_', ' ').toUpperCase()}<br>
                    Puntaje: ${score}% ‚úÖ
                </p>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-out forwards';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Reset all progress
        function resetAllProgress() {
            if (confirm('¬øEst√°s seguro de que quieres resetear todo el progreso?')) {
                localStorage.removeItem('finx_user_progress');
                console.log('Progreso reseteado');
                updateDisplay();
            }
        }
        
        // View raw data
        function viewRawData() {
            const progress = getUserProgress();
            console.log('Datos de progreso:', progress);
            alert('Revisa la consola para ver los datos completos');
        }
        
        // Update the display
        function updateDisplay() {
            const progress = getUserProgress();
            
            // Update lesson statuses
            const lessons = [
                { id: 'ahorro_inteligente', elementId: 'status-ahorro', name: 'Ahorro Inteligente' },
                { id: 'savings_ninja', elementId: 'status-savings', name: 'Savings Ninja' },
                { id: 'investment_wizard', elementId: 'status-investment', name: 'Investment Wizard' }
            ];
            
            lessons.forEach(lesson => {
                const element = document.getElementById(lesson.elementId);
                const lessonData = progress.lessons[lesson.id];
                
                if (!lessonData || !lessonData.unlocked) {
                    element.textContent = 'üîí Bloqueado';
                    element.className = 'status-indicator status-locked';
                } else if (lessonData.passed) {
                    element.textContent = `‚úÖ Completado (${lessonData.score}%)`;
                    element.className = 'status-indicator status-completed';
                } else {
                    element.textContent = 'üîì Desbloqueado';
                    element.className = 'status-indicator status-unlocked';
                }
            });
            
            // Update XP and level
            document.getElementById('totalXP').textContent = progress.totalXP;
            document.getElementById('userLevel').textContent = Math.floor(progress.totalXP / 100) + 1;
        }
        
        // Initialize display on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
        });
        
        // CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes slideOutRight {
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
